{% extends 'base.html' %}
{% load static %}

{% block title %}Categories | Khmer25 Admin{% endblock %}
{% block body_class %}page-categories{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h3 class="mb-1">Categories</h3>
    <p class="text-muted mb-0">Manage product categories and icons.</p>
  </div>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal" data-category-id="" data-title-en="" data-title-kh="">Add category</button>
</div>

<div class="card p-3">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th>Preview</th>
          <th>ID</th>
          <th>Category</th>
          <th>Items</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for category in categories %}
        <tr>
          <td>
            {% if category.image and "via.placeholder.com" not in category.image.url %}
              <img src="{{ category.image.url }}" class="rounded" style="width: 72px; height: 48px; object-fit: cover;" alt="{{ category.title_en }}">
            {% else %}
              <img src="{% static 'accounts/img/placeholder.svg' %}" class="rounded" style="width: 72px; height: 48px; object-fit: cover;" alt="{{ category.title_en }}">
            {% endif %}
          </td>
          <td>#{{ category.id }}</td>
          <td>
            <div class="fw-semibold">{{ category.title_en }}</div>
            <div class="text-muted small">{{ category.title_kh }}</div>
          </td>
          <td>{{ category.sub_count }}</td>
          <td class="text-end">
            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#categoryModal" data-category-id="{{ category.id }}" data-title-en="{{ category.title_en }}" data-title-kh="{{ category.title_kh }}">Edit</button>
            <form class="d-inline" method="post" action="{% url 'admin-categories-delete' category.id %}" data-swal-confirm data-swal-title="Delete category?" data-swal-text="This will remove the category permanently.">
              {% csrf_token %}
              <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center text-muted">No categories found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add / Edit Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="categoryForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="category_id" id="categoryId">
          <div class="mb-3">
            <label class="form-label">Category name (EN)</label>
            <input class="form-control" name="title_en" id="categoryTitleEn" placeholder="e.g. Beverages" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Category name (KH)</label>
            <input class="form-control" name="title_kh" id="categoryTitleKh" placeholder="ឧ. ភេសជ្ជៈ" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Icon / Image</label>
            <input class="form-control" type="file" name="image">
          </div>
          <div class="border rounded p-2 d-flex align-items-center gap-2">
            <img src="{% static 'accounts/img/placeholder.svg' %}" class="rounded" alt="Preview">
            <span class="text-muted small">Preview</span>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" form="categoryForm">Save</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const categoryModal = document.getElementById("categoryModal");
  categoryModal?.addEventListener("show.bs.modal", (event) => {
    const button = event.relatedTarget;
    const categoryId = button?.getAttribute("data-category-id") || "";
    const titleEn = button?.getAttribute("data-title-en") || "";
    const titleKh = button?.getAttribute("data-title-kh") || "";
    document.getElementById("categoryId").value = categoryId;
    document.getElementById("categoryTitleEn").value = titleEn;
    document.getElementById("categoryTitleKh").value = titleKh;
  });

  const status = "{{ request.GET.status|default:'' }}";
  if (status === "created") {
    Swal.fire({ icon: "success", title: "Category created", timer: 1500, showConfirmButton: false });
  } else if (status === "updated") {
    Swal.fire({ icon: "success", title: "Category updated", timer: 1500, showConfirmButton: false });
  } else if (status === "deleted") {
    Swal.fire({ icon: "success", title: "Category deleted", timer: 1500, showConfirmButton: false });
  }
</script>
{% endblock %}
