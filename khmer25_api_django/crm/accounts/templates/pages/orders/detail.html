{% extends 'base.html' %}
{% load static %}

{% block title %}Order Detail | Khmer25 Admin{% endblock %}
{% block body_class %}page-orders{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h3 class="mb-1">Order {{ order.order_code|default:order.id }}</h3>
    <p class="text-muted mb-0">Placed {{ order.created_at|date:"M d, Y" }} â€¢ {{ order.order_status|title }}</p>
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-primary" type="button">Download invoice</button>
    <form method="post" id="markDeliveredForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="mark_delivered">
      <button class="btn btn-primary" type="submit">Mark delivered</button>
    </form>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card p-3 mb-3">
      <h5 class="mb-3">Order Items</h5>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Item</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
            <tr>
              <td>{{ item.product_name|default:item.product.name }}</td>
              <td>{{ item.quantity }}</td>
              <td>${{ item.price }}</td>
              <td>${{ item.subtotal }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted">No items found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-end mt-3">
        <div class="text-end">
          <div class="text-muted">Subtotal: ${{ subtotal }}</div>
          <div class="fw-semibold">Total: ${{ order.total_amount }}</div>
        </div>
      </div>
    </div>

    <div class="card p-3">
      <h5 class="mb-3">Order Timeline</h5>
      <div class="timeline">
        <div class="timeline-item">
          <div class="fw-semibold">Order confirmed</div>
          <div class="text-muted small">Mar 08, 10:12 AM</div>
        </div>
        <div class="timeline-item">
          <div class="fw-semibold">Payment received</div>
          <div class="text-muted small">Mar 08, 10:18 AM</div>
        </div>
        <div class="timeline-item">
          <div class="fw-semibold">Preparing shipment</div>
          <div class="text-muted small">Mar 08, 01:40 PM</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card p-3 mb-3">
      <h5 class="mb-3">Customer</h5>
      <div class="d-flex align-items-center gap-3 mb-3">
        <img class="avatar" src="{% static 'accounts/img/placeholder.svg' %}" alt="Customer">
        <div>
          <div class="fw-semibold">{{ order.customer_name|default:"Guest" }}</div>
          <div class="text-muted small">{{ order.user.email|default:"-" }}</div>
        </div>
      </div>
      <div class="text-muted small">Phone</div>
      <div class="mb-2">{{ order.phone }}</div>
      <div class="text-muted small">Shipping address</div>
      <div>{{ order.address }}</div>
    </div>
    <div class="card p-3">
      <h5 class="mb-3">Payment</h5>
      {% if payments and payments.0.receipt_image %}
        <div class="mb-3">
          <div class="text-muted small mb-2">Receipt (QR)</div>
          {% if payments.0.receipt_image.url|lower|slice:"-4:" == ".pdf" %}
            <a href="{{ payments.0.receipt_image.url }}" target="_blank" rel="noopener">View receipt (PDF)</a>
          {% else %}
            <img src="{{ payments.0.receipt_image.url }}" alt="Receipt" class="rounded" style="width: 120px; height: 120px; object-fit: cover; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#receiptModal" data-receipt="{{ payments.0.receipt_image.url }}">
          {% endif %}
        </div>
      {% endif %}
      <div class="d-flex justify-content-between mb-2">
        <span class="text-muted">Method</span>
        <span>{{ order.payment_method }}</span>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span class="text-muted">Status</span>
        {% if order.payment_status == "paid" %}
          <span class="badge badge-soft badge-success">Paid</span>
        {% elif order.payment_status == "pending" %}
          <span class="badge badge-soft badge-warning">Pending</span>
        {% else %}
          <span class="badge badge-soft badge-danger">Failed</span>
        {% endif %}
      </div>
      <div class="d-flex justify-content-between">
        <span class="text-muted">Transaction</span>
        <span>{% if payments %}{{ payments.0.id }}{% else %}-{% endif %}</span>
      </div>
      {% with items.0.product.payway_link as payway_link %}
      {% if payway_link %}
      <div class="d-grid gap-2 mt-3">
        <button class="btn btn-primary" type="button" id="openPaywayBtn" data-payway-link="{{ payway_link|default:'' }}">Pay via ABA PayWay</button>
        <div class="text-muted small">Opens the ABA PayWay / KHQR page in a popup so the customer can scan and pay.</div>
      </div>
      {% endif %}
      {% endwith %}
    </div>
  </div>
</div>

<div class="modal fade" id="receiptModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Receipt QR</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="receiptModalImage" src="" alt="Receipt" class="img-fluid rounded">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const status = "{{ request.GET.status|default:'' }}";
  if (status === "delivered") {
    Swal.fire({ icon: "success", title: "Order delivered & paid", timer: 1500, showConfirmButton: false });
  }

  const receiptModal = document.getElementById('receiptModal');
  receiptModal?.addEventListener('show.bs.modal', (event) => {
    const trigger = event.relatedTarget;
    const url = trigger?.getAttribute('data-receipt');
    const img = document.getElementById('receiptModalImage');
    if (img && url) {
      img.src = url;
    }
  });

  const markForm = document.getElementById("markDeliveredForm");
  markForm?.addEventListener("submit", async (event) => {
    event.preventDefault();
    const formData = new FormData(markForm);
    const response = await fetch("", {
      method: "POST",
      headers: { "X-Requested-With": "XMLHttpRequest" },
      body: formData,
    });
    if (response.ok) {
      Swal.fire({ icon: "success", title: "Order delivered & paid", timer: 1500, showConfirmButton: false });
      setTimeout(() => window.location.reload(), 1600);
    } else {
      Swal.fire({ icon: "error", title: "Update failed", text: "Please try again." });
    }
  });

  const payBtn = document.getElementById("openPaywayBtn");
  payBtn?.addEventListener("click", () => {
    const link = payBtn.getAttribute("data-payway-link");
    if (!link) return;
    window.open(link, "payway", "width=520,height=780,noopener,noreferrer");
  });
</script>
{% endblock %}
